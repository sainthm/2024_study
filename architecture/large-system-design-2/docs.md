# Docs

<br>

# 1장. 근접성 서비스

- 근접성 서비스(proximity service) 설계

## 1단계: 문제 이해 및 설계 범위 확정

- 기능 요구사항
    - 검색 반경
    - 최대 허용 반경
    - UI 검색 반경 변경 기능
    - 정보의 추가, 삭제, 갱신 방안
    - 실시간 업데이트 여부
    - 화면 자동 갱신 여부
- 비기능 요구사항(non-functional requirements):
    - 낮은 응답 지연
    - 데이터 보호(아래는 사용자 위치 정보 관련 보호 법안)
        - GDPR
        - CCPA
    - 고가용성 및 규모 확장성
- 개략적 규모 추정:
    - QPS 계산

<br>

## 2단계: 개략적 설계안 제시 및 동의 구하기

- API 설계
    - RESTful API (GET, POST, PUT, DELETE)
    - 데이터 모델
- 개략적 설계안
    - 로드밸런서를 통한 분기(LBS, business_id)
    - 데이터베이스 클러스터
- 주변 사업장 검색 알고리즘
    - 데이터베이스 이름을 나열하기보다는 **`지리적 위치 색인`** 동작 설명 위주
        - Geohash in Redis
        - PostGIS extension
    - 방안1: 2차원 검색
        - 지리적 정보 색인 생성 방안: (→ 지도를 작은 영역으로 분할하고 고속 검색이 가능하도록 색인 생성)
            - 해시
                - **균등 격자**
                - 지오해시
                - 카르테시안 계층
            - 트리
                - **쿼드트리**
                - **구글 S2**
                - R-tree
    - 방안2: 균등 격자
        - 데이터 분포는 균등하지 않음
    - 방안3: 지오해시
        - 12단계 정밀도
        - 격자 가장자리 관련 이슈 존재
    - 방안4: 쿼드트리
        - 격자의 내용이 특정 기준을 만족할 때까지 2차원 공간을 재귀적으로 사분면 분할
        - 메모리 기반
    - 방안5: 구글 S2
        - 지구를 힐베르트 곡선을 사용하여 1차원 인덱싱
            - 특성: 힐베르트 곡선 상에서 인접한 두 지점은 색인화 이후 1차원 공간 내에서도 인접한 위치에 존재
        - Geometry 라이브러리
        - 메모리 기반
        - 장점:
            - 임의 지역에 다양한 수준의 영역 지정이 가능하여 **`Geofence`** 구현에 용이함
            - **`영역 지정 알고리즘`**:
                - 최소 / 최고 수준, 최대 셀 개수 등을 지정 가능
    - 지오해시 vs 쿼드트리
        - 지오해시
            - 구현과 사용이 쉬움, 트리 구축 필요 X
            - 지정 반경 이내 사업장 검색 지원
            - 정밀도 고정 → 격자 크기 고정 (인구 밀도에 따른 동적 격자 크기 조절 불가능)
            - 색인 갱신 쉬움
        - 쿼드트리
            - 트리 구축이 필요하여 지오해시에 비해, 구현하기 살짝 까다로움
            - k번째로 가까운 사업장까지의 목록을 구할 수 있음 (ex. 거리에 상관없이 가까운 주유소)
                - 하위 노드 분할 과정이 숫자 k 기반
                - k개를 찾을 때까지 검색 범위를 자동으로 조정 가능
            - 인구 밀도에 따른 격자 크기 동적 조정 가능
            - 트리형태의 자료구조다 보니, 지오해시보다 색인 갱신이 까다로움
                - 루트 부터 말단까지 순회 필요
                - 색인 갱신 시간 복잡도는 O(logn)
                - 락을 사용해야 하므로 **다중 스레드** 지원해야하는 경우에는 더 복잡해짐
                - 리밸런싱이 필요한 경우 더 복잡해짐
                    - 말단 노드에 새로운 사업장을 추가할 수 없는 경우 리밸런싱 필요
                    - 말단 노드가 담당해야하는 구간의 크기를 필요한 양보다 크게 잡아서 해결 가능

<br>

## 3단계: 상세 설계

- 지금까지 시스템의 전반적인 형태를 파악
- 상세 설계 단계에서는 아래의 항목을 살펴봄
    - 데이터베이스 규모 확장
    - 캐시
    - 지역 및 가용성 구역
    - 시간대 또는 사업장 유형에 따른 검색
    - 최종 아키텍처 다이어그램

### 데이터베이스 규모 확장

- 사업장 테이블
    - 샤딩을 적용하기 좋은 후보
    - 가장 간단한 방법 → 사업장 ID 기준
- 지리 정보 색인 테이블(지오해시 기준)
    - 방안1: 모든 사업장 ID를 JSON 배열 → 같은 열에 저장 → 특정한 지오해시에 속한 모든 사업장 ID가 한 열에 보관
        - 갱신이 필요한 경우:
            - JSON 배열을 읽고 갱신할 사업장 ID를 찾아야함
            - 병력 실행 연산 결과로 데이터 소실을 막기위해 락을 사용해야함
    - **방안2**: 같은 지오해시에 속한 사업장 ID 각각을 별도 열로 저장 → 사업장마다 한 개 레코드 필요
        - 복합 키(compound key) = 지오해시 + 사업장 ID 컬럼 → 사업장 정보 추가 및 삭제가 쉬움 (락 필요 X)

### 지리 정보 색인의 규모 확장

- 테이블에 보관되는 데이터의 실제 크기를 고려한 후 샤딩 방법을 결정해야함
- 읽기 연산의 빈도가 높다면 여러 데이터베이스 서버로 부하 분산 권장
- 관계형 데이터베이스의 두 가지 부하분산 전략:
    - 읽기 연산을 지원할 사본 데이터베이스 서버 추가
    - 샤딩 적용

### 캐시

- 정말로 캐시 계층이 필요한지 우선적으로 확인 필요
- 벤치마킹과 비용 분석에 주의 필요
- 캐시 키:
    - 직관적인 캐시 키는 사용자 위치의 위도, 경도 정보로 보이지만 문제점이 있음
        - 위치 정보가 절대적으로 정확하지는 않음
            - 측정할때마다 조금씩 달라질 수 있음
        - 사용자가 이동 시 위도, 경도 정보도 미세하게 변경
    - 지오해시, 쿼드트리는 같은 격자 내 모든 사업장이 같은 해시값을 갖도록 만들 수 있음
- 캐디 데이터 유형:
    
    
    | 키 | 값 |
    | --- | --- |
    | 지오해시 | 해당 격자 내의 사업장 ID 목록 |
    | 사업장 ID | 사업장 정보 객체 |
    - 격자 내 사업장 ID:
        - 사업장 정보는 상대적으로 안정적이라 자주 변경되지 않음
        - 특정 지오해시에 해당하는 사업장 ID 목록을 미리 계산한 다음 레디스 같은 키-밸류 저장소에 캐시

### 지역 및 가용성 구역

- 지금까지 다룬 위치 기반 서비스를 여러 지역과 가용성 구역에 설치
- 기대 효과:
    - 사용자와 시스템 사이의 물리적 거리 최소화
    - 트래픽을 인구 밀도에 따라 고르게 분산 → 유연성 확보 가능
    - 서비스 지역의 privacy law에 맞는 운영 가능

### 추가 질문: 시간대, 혹은 사업장 유형별 검색

- 지금 영업 중인 사업장 정보만 받아오고 싶은 경우는 어떻게 진행?!
    - 메커니즘(지오해시, 쿼드트리)을 통해, 전세계를 작은 격자들로 분할
    - 분할된 격자 내에서 검색 결과로 얻을 수 있는 사업장 수는 상대적으로 적음
    - 근처 사업장 정보를 추출 후, 유형에 따라 필터링
    - 영업 시간대와 같은 정보는 사전에 사업장 정보 테이블에 보관 필요


### 최종 설계도

<img width="532" alt="스크린샷 2024-02-14 오후 2 03 37" src="https://github.com/sainthm/2024_study/assets/54525036/e773020d-7bbc-4db7-9e5c-36d0c57fa564">

- 클라이언트 앱은 사용자의 위치와 검색 반경을 로드밸런서로 전달
- 로드밸런서 → LBS
- LBS는 지오해시 길이 계산 → 리스트에 추가
- 리스트 내, 지오해시에 대해 LBS는 지오해시 레디스 서버 호출 → 대응하는 모든 사업장 ID 추출
    - 연산에 대해, 병렬 수행을 통해 검색결과 지연시간 감소 가능
- 반환된 사업장 ID → 사업장 정보(business) 레디스 서버 조회 → 각 사업장의 상세 정보 취득
- 상세 정보를 통해, 사업장과 사용자 간 거리 계산 → 우선순위 책정 → 클라이언트 앱에 반환


## 4단계:  마무리

- 지리 정보 색인 기법을 활용하는 전형적인 LBS 서비스 설계
- 살펴본 색인 방안:
    - 2차원 검색
    - 균등 분할 격자
    - **`지오해시`**
    - **쿼드트리**
    - **구글 S2**
- 상세 설계 중 고려한 사항:
    - 캐시 활용 방안
        - 캐시를 활용한 지연 시간 감소 방법
        - 캐시 대상 정보
        - 주변 사업장 검색을 위한 캐시 활용법
    - 데이터베이스 규모 확장법
        - 복제
        - 샤딩

# Docs

<br>

# 1장. 근접성 서비스

- 근접성 서비스(proximity service) 설계

## 1단계: 문제 이해 및 설계 범위 확정

- 기능 요구사항
    - 검색 반경
    - 최대 허용 반경
    - UI 검색 반경 변경 기능
    - 정보의 추가, 삭제, 갱신 방안
    - 실시간 업데이트 여부
    - 화면 자동 갱신 여부
- 비기능 요구사항(non-functional requirements):
    - 낮은 응답 지연
    - 데이터 보호(아래는 사용자 위치 정보 관련 보호 법안)
        - GDPR
        - CCPA
    - 고가용성 및 규모 확장성
- 개략적 규모 추정:
    - QPS 계산

<br>

## 2단계: 개략적 설계안 제시 및 동의 구하기

- API 설계
    - RESTful API (GET, POST, PUT, DELETE)
    - 데이터 모델
- 개략적 설계안
    - 로드밸런서를 통한 분기(LBS, business_id)
    - 데이터베이스 클러스터
- 주변 사업장 검색 알고리즘
    - 데이터베이스 이름을 나열하기보다는 **`지리적 위치 색인`** 동작 설명 위주
        - Geohash in Redis
        - PostGIS extension
    - 방안1: 2차원 검색
        - 지리적 정보 색인 생성 방안: (→ 지도를 작은 영역으로 분할하고 고속 검색이 가능하도록 색인 생성)
            - 해시
                - **균등 격자**
                - 지오해시
                - 카르테시안 계층
            - 트리
                - **쿼드트리**
                - **구글 S2**
                - R-tree
    - 방안2: 균등 격자
        - 데이터 분포는 균등하지 않음
    - 방안3: 지오해시
        - 12단계 정밀도
        - 격자 가장자리 관련 이슈 존재
    - 방안4: 쿼드트리
        - 격자의 내용이 특정 기준을 만족할 때까지 2차원 공간을 재귀적으로 사분면 분할
        - 메모리 기반
    - 방안5: 구글 S2
        - 지구를 힐베르트 곡선을 사용하여 1차원 인덱싱
            - 특성: 힐베르트 곡선 상에서 인접한 두 지점은 색인화 이후 1차원 공간 내에서도 인접한 위치에 존재
        - Geometry 라이브러리
        - 메모리 기반
        - 장점:
            - 임의 지역에 다양한 수준의 영역 지정이 가능하여 **`Geofence`** 구현에 용이함
            - **`영역 지정 알고리즘`**:
                - 최소 / 최고 수준, 최대 셀 개수 등을 지정 가능
    - 지오해시 vs 쿼드트리
        - 지오해시
            - 구현과 사용이 쉬움, 트리 구축 필요 X
            - 지정 반경 이내 사업장 검색 지원
            - 정밀도 고정 → 격자 크기 고정 (인구 밀도에 따른 동적 격자 크기 조절 불가능)
            - 색인 갱신 쉬움
        - 쿼드트리
            - 트리 구축이 필요하여 지오해시에 비해, 구현하기 살짝 까다로움
            - k번째로 가까운 사업장까지의 목록을 구할 수 있음 (ex. 거리에 상관없이 가까운 주유소)
                - 하위 노드 분할 과정이 숫자 k 기반
                - k개를 찾을 때까지 검색 범위를 자동으로 조정 가능
            - 인구 밀도에 따른 격자 크기 동적 조정 가능
            - 트리형태의 자료구조다 보니, 지오해시보다 색인 갱신이 까다로움
                - 루트 부터 말단까지 순회 필요
                - 색인 갱신 시간 복잡도는 O(logn)
                - 락을 사용해야 하므로 **다중 스레드** 지원해야하는 경우에는 더 복잡해짐
                - 리밸런싱이 필요한 경우 더 복잡해짐
                    - 말단 노드에 새로운 사업장을 추가할 수 없는 경우 리밸런싱 필요
                    - 말단 노드가 담당해야하는 구간의 크기를 필요한 양보다 크게 잡아서 해결 가능

<br>

## 3단계: 상세 설계

- 지금까지 시스템의 전반적인 형태를 파악
- 상세 설계 단계에서는 아래의 항목을 살펴봄
    - 데이터베이스 규모 확장
    - 캐시
    - 지역 및 가용성 구역
    - 시간대 또는 사업장 유형에 따른 검색
    - 최종 아키텍처 다이어그램
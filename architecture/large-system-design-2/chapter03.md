
# 3장. 구글 맵

> 실제 우리가 사용하는 제품보다는 단순한 형태의 구글 맵 설계

### 구글 맵

- 2005년 프로젝트 구글 맵 발족 → 웹 기반 지도 서비스 개발
- 위성 이미지, 거리 뷰, 실시간 교통 상황, 경로 계획 등 다양한 서비스 제공
- 사용자가 목적지와 경로를 찾을 수 있도록 도움
- 2021년 3월 기준 DAU 10억명
- 전 세계 99% 지역의 지도 제공
- 정확한 실시간 위치 정보를 제공하기 위해 매일 2500만 건의 업데이트 반영
- 엄청나게 복잡한 제품


## 1단계: 문제 이해 및 설계 범위 확정

- DAU: 10억명
- 개발 포인트: 위치 갱신, 경로 안내, ETA(Estimated Time of Arrival), 지도 표시
- 도로 데이터: 다양한 경로를 확보했다고 가정하며, 수 TB 수준의 가공되지 않은 데이터
- 실시간 교통상황 고려
- 다양한 이동방법 고려(운전, 대중교통, 도보 등)
- 경유지 고려 X
- 사업장 위치 및 사진 출력 고려 X


### 기능 요구사항

> 지원할 주 단말은 스마트폰으로 가정
> 
- 사용자 위치 갱신
- 경로 안내 서비스 (ETA 포함)
- 지도 표시

### 비기능 요구사항 및 제약사항

- 정확도
- 부드러운 경로 표시
- 데이터 및 배터리 사용량
- 가용성 및 규모 확장성 고려

## 지도 101

### 측위 시스템

> 측위 시스템(positioning system): 구 표면 상의 위치를 표현하는 체계

- 위경도 기반 측위 시스템의 경우, 최상단에는 북극이 있고 최하단에는 남극이 위치
- 측위 시스템 내 표현:
    - 위도: 주어진 위치가 얼마나 북쪽/남쪽인지 표현
    - 경도: 얼마나 동쪽/서쪽인지 표현

### 3차원 위치의 2차원 변환

> 지도 투영법(map projection): 3차원 구 위의 위치를 2차원 평면에 대응시키는 절차 (a.k.a 도법)

- 도법은 다양하며, 각각은 다른 도법과 차별되는 장단점이 있음
- 거의 모든 투영법은 실제 지형의 기하학적 특성을 왜곡한다는 공통점이 있음
- 도법 예시:
    - 메르카토르 도법
    - 퍼스 퀸쿤셜 도법
    - 칼-페터스 도법
    - 윈켈 트리펠 도법
- 구글 맵은 메르카토르 도법을 조금 변형한 `웹 메르카토르` 도법 채택

### 지오코딩

> 지오코딩(Geocoding): 주소를 지리적 측위 시스템의 좌표로 변환하는 프로세스
> 
- 지오코딩 결과를 반대로 주소로 변환하는 프로세스는 역 지오코딩
- 지오코딩 수행 방법:
    - 인터폴레이션(Interpolation, 써넣음, 보간법):
        - GIS(Geographic Information System)와 같은 다양한 시스템이 제공하는 데이터 결합
        - 도로망을 지리적 좌표 공간에 대응시키는 방법을 제공하는 여러 시스템 가운데 하나

### 지오해싱

> 지오해싱(Geohashing): 지도 위 특정 영역을 영문자와 숫자로 구성된 짧은 문자열에 대응시키는 인코딩 체계
> 
- 2차원의 평면 공간으로 표현된 지리적 영역 위의 격자를 더 작은 격자로 재귀적으로 분할
- 각 격자는 정사각형일 수도 있고 사각형일 수도 있음
- 어떤 격자를 재귀적으로 분할한 결과로 생성된 더 작은 격자에는 0부터 3까지의 번호를 부여
- 원하는 크기의 격자가 만들어질 때까지 반복하여 분할
- 다양한 용도가 있음


### 지도표시

> 지도를 화면에 렌더링
> 
- 타일: 지도를 화면에 표시하는 가장 기본적인 개념
    - 지도를 하나의 이미지로 표시하는 대신 작은 타일로 쪼개어 표시
    - 클라이언트는 사용자가 보려는 영역에 관계된 타일만 다운받아 모자이크처럼 이어 붙인 다음 화면에 뿌림
    - 지도의 확대/축소를 지원하려면 확대 수준에 따라 다른 종류의 타일 준비 필요
    - 현재 클라이언트가 보려는 지도 확대 수준(zoom level)에 근거하여 어떤 크기의 타일을 가져올지 고름


### 경로 안내 알고리즘을 위한 도로 데이터 처리

- 대부분의 경로 탐색 알고리즘은 `데이크스트라(Djikstra) 알고리즘`이나 `A* 경로 탐색 알고리즘`의 변종
- 모든 경로 탐색 알고리즘은 교차로를 노드, 도로는 노드를 잇는 엣지로 표현하는 `그래프 자료 구조` 가정
- 대부분의 경로 탐색 알고리즘의 성능은 주어진 그래프 크기에 민감 → 관리 기능 단위로 분할할 필요가 있음
- 전 세계 도로망을 더 작은 단위로 분할하는 방법 가운데 하나는 지도 표시에 사용하는 타일 기반 분할법과 유사함
    - 지오해싱과 비슷한 분할 기술을 적용하여 세계를 작은 격자로 나눔
    - 각 격자 안의 도로망을 노드와 엣지로 구성된 그래프 자료 구조로 변환
    - 각 격자는 경로 안내 타일(routing tile)이라고 부름
    - 각 타일은 도로로 연결된 다른 타일에 대한 레퍼런스를 유지
- 지도 타일 → PNG (이미지 파일)
- 경로 안내 타일 → Binary file (도로 데이터로 구성)

### 계층적 경로 안내 타일

> 경로 안내가 효과적으로 동작하려면 필요한 수준의 구체성을 갖춘 도로 데이터 필요
> 
- 보통 구체성 정도를 상, 중, 하로 구분하여 세 가지 종류의 경로 안내 타일 준비
    
    
    | 구분 | 구체성 | 크기 | 데이터 |
    | --- | --- | --- | --- |
    | 상 | 높음 | 작음 | 지방도로 수준(local roads) |
    | 중 | 중간 | 중간 | 간선도로 수준(arterial roads) |
    | 하 | 낮음 | 큼 | 고속도로 수준(expressway) |
- 각 타일에는 다른 정밀도 타일로 연결되는 엣지가 있을 수 있음


## 개략적 규모 추정

- 거리 참고사항:
    - 1피트 = 0.3408 미터
    - 1킬로미터 = 0.6214 마일
    - 1킬로미터 = 1000미터

### 저장소 사용량

- 세계 지도
- 메타데이터
- 도로 정보 → 외부에서 받은 수 TB 용량의 도로 데이터 보유

### 세계 지도

- 지도를 확대(zoom in)할 때마다 하나의 타일을 네 장의 타일로 펼친다고 가정
- 세계 지도를 21번 확대하여 볼 수 있으려면 4.4조개의 타일 필요
- 한 장의 타일이 256 x 256 픽셀 압축 PNG 파일 → 100KB의 저장공간 필요
- 최대 확대시 필요 타일을 전부 저장하려면
    $4.4 조 * 100 KB = 440 PB$









































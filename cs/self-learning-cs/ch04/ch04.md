# Chapter 4. CPU의 작동 원리

- ALU와 제어장치
- 레지스터의 종류와 역할
- 명령어 사이클
- 인터럽트


## ALU와 제어장치

- CPU는 메모리에 저장된 명령어를 읽어 들이고, 해석하고, 실행하는 장치
- 계산을 담당하는 ALU, 명령어를 읽어 들이고 해석하는 제어장치, 작은 임시 저장 장치인 레지스터

### ALU

- Arithmetic and Logical Unit, 산술 논리 장치
- 레지스터로부터 피연산자를 받아들이고 제어장치로부터 제어 신호를 받아들임
- 연산한 결괏값과 **플래그**를 내보냄
- 계산을 위해서 피연산자와 수행할 연산 필요
- ALU는 레지스터를 통해 피연산자를 받아들이고 제어장치로부터 수행할 연산을 알려주는 제어 신호를 받아들임
- 산술 연산, 논리 연산 등 다양한 연산 수행
- 결괏값은 바로 메모리에 저장되지 않고 레지스터에 일시적으로 저장됨
  - c.f. 오버플로우(Overflow): 연산 결과가 연산 결과를 담을 레지스터보다 큰 상황
- 연산 결과에 대한 추가적인 정보인 플래그(flag)를 내보냄
  - CPU가 프로그램을 실행하는 도중 반드시 기억해야 하는 참고 정보
  - 플래그 레지스터에 저장
  - 대표적인 플래그 종류:
    - 부호 플래그: {1:음수, 0:양수}
    - 제로 플래그: {1:0, 0:0이 아님}
    - 캐리 플래그: 올림수나 빌림수가 발생했는지 여부 {1:발생, 0:발생X}
    - 오버플로우 플래그: {1:발생, 0:발생X}
    - 인터럽트 플래그: 인터럽트가 가능한지 여부 {1:가능, 0:불가능}
    - 슈퍼바이저 플래그: 커널 모드로 실행 중인지, 사용자 모드로 실행 중인지 여부 {1:커널 모드, 0:사용자 모드}

### 제어장치

- 제어 신호를 내보내고 명령어를 해석하는 부품
- CPU의 구성 요소 중 가장 정교하게 설계된 부품 중 하나
- CPU 제조사마다 제어장치의 구현 방식 및 명령어를 해석하는 방식, 받아들이고 내보낸 정보에 조금씩 차이가 존재

#### 제어장치가 받아들이는 정보

- 제어장치는 클럭 신호를 받아들임
- 제어장치는 '해석해야 할 명령어'를 받아들임
  - 명령어는 **명령어 레지스터**에 보관
- 제어장치는 플래그 레지스터 속 플래그 값을 받아들임
- 제어장치는 시스템 버스, 그중에서 제어 버스로 전달된 제어 신호를 받아들임

#### 제어장치가 내보내는 정보
- CPU 외부(제어 버스로 제어 신호를 내보냄)
  - 메모리 전달 제어 신호
  - 입출력 장치(보조기억장치) 전달 제어 신호
- CPU 내부
  - ALU 전달 제어 신호: 수행할 연산 지시
  - 레지스터 전달 제어 신호: 레지스터 간 데이터 이동, 레지스터에 저장된 명령어 해석


## 레지스터

- 프로그램 속 명령어와 데이터는 실행 전후로 반드시 레지스터에 저장
- 레지스터에 저장된 값만 잘 관찰해도 프로그램의 실행 흐름 파악 가능

### 반드시 알아야 할 레지스터

- 프로그램 카운터
- 명령어 레지스터
- 메모리 주소 레지스터
- 메모리 버퍼 레지스터
- 플래그 레지스터
- 범용 레지스터
- 스택 포인터
- 베이스 레지스터


#### 프로그램 카운터

- 메모리에서 가여올 명령어의 주소를 저장
- 명령어 포인터(IP, Instruction Pointer)로 부르는 CPU도 존재

#### 명령어 레지스터

- 메모리에서 읽어들인 해석할 명령어를 저장
- 제어장치는 명령어 레지스터 속 명령어를 받아들이고 해석한 뒤, 제어 신호를 내보냄

#### 메모리 주소 레지스터

- **메모리의 주소를 저장**하는 레지스터
- CPU가 읽어 들이고자 하는 주소 값을 주소 버스로 보낼 때, 메모리 주소 레지스터를 거침

#### 메모리 버퍼 레지스터

- 메모리와 주고받을 값인 **데이터와 명령어를 저장**하는 레지스터
- 메모리에 쓰고 싶은 값, 메모리로부터 전달받은 값이 거침
- 데이터 버스로 주고받을 값은 메모리 버퍼 레지스터를 거침
- 메모리 데이터 레지스터라고도 부름

#### 범용 레지스터

- 다양하고 일반적인 상황에서 자유롭게 사용할 수 있는 레지스터
- 데이터와 주소를 모두 저장 가능
- 일반적으로 CPU 안에 여러 개의 범용 레지스터 존재

#### 플래그 레지스터

- ALU 연산 결과에 따른 플래그 저장
- 연산 결과 또는 CPU 상태에 대한 부가적인 정보 저장

## 특정 레지스터를 이용한 주소 지정 방식

- 프로그램 카운터, 스택 포인터, 베이스 레지스터는 주소 지정에 사용될 수 있는 특별한 레지스터
- **스택 주소 지정 방식**에 스택 포인터를 사용하고 프로그램 카운터와 베이스 레지스터는 **변위 주소 지정 방식**에 사용

### 스택 주소 지정 방식

- 스택과 스택 포인터를 이용한 주소 지정 방식
- 스택 포인터는 스택의 꼭대기를 가리키는 레지스터
  - 스택에 마지막으로 저장한 값의 위치를 저장
- **스택 영역**: 메모리 안에 스택처럼 사용할 정해져 있는 영역 (암묵적으로 약속된 영역)

### 변위 주소 지정 방식

- 오퍼랜드 필드의 값(변위)과 특정 레지스터의 값을 더하여 유효 주소를 얻어내는 주소 지정 방식
- 오퍼랜드 필드의 주소와 어떤 레지스터를 더하는지에 따라 **상대 주소 지정 방식**, **베이스 레지스터 주소 지정 방식**으로 나뉨

#### 상대 주소 지정 방식

- 오퍼랜드와 프로그램 카운터의 값을 더하여 유효 주소를 얻는 방식
- 모든 코드를 실행하는 것이 아닌, 분기하여 특정 주소의 코드를 실행할 때 사용

#### 베이스 레지스터 주소 지정 방식

- 오퍼랜드와 베이스 레지스터의 값을 더하여 유효 주소를 얻는 방식
- 베이스 레지스터는 "기준이될 주소" 역할 + 오퍼랜드는 "기준 주소로부터 떨어진 거리" 역할

